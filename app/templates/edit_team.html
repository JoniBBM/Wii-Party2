{% extends "base.html" %}

{% block title %}Team bearbeiten - {{ team.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2><i class="fas fa-users"></i> Team "{{ team.name }}" bearbeiten</h2>
            <form method="POST" action="" novalidate>
                {{ form.hidden_tag() }}
                
                <!-- Team-Grunddaten -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Team-Grunddaten</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            {{ form.team_name.label(class="form-control-label") }}
                            {{ form.team_name(class="form-control" + (" is-invalid" if form.team_name.errors else ""), placeholder="Teamname") }}
                            {% if form.team_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.team_name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.character_id.label(class="form-control-label") }}
                            {{ form.character_id(class="form-control" + (" is-invalid" if form.character_id.errors else "")) }}
                            {% if form.character_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.character_id.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Passwort ändern -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-key"></i> Passwort ändern</h5>
                    </div>
                    <div class="card-body">
                        {% if team.welcome_password %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Aktuelles Passwort:</strong> 
                            <code>{{ team.welcome_password }}</code>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            {{ form.password.label(class="form-control-label") }}
                            {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), placeholder="Neues Passwort (leer lassen, um nicht zu ändern)") }}
                            {% if form.password.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.password.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.confirm_password.label(class="form-control-label") }}
                            {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), placeholder="Passwort bestätigen") }}
                            {% if form.confirm_password.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.confirm_password.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Spielstatus -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-dice"></i> Spielstatus bearbeiten</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.current_position.label(class="form-control-label") }}
                                    {{ form.current_position(class="form-control" + (" is-invalid" if form.current_position.errors else ""), placeholder="0-72", value=team.current_position) }}
                                    {% if form.current_position.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.current_position.errors %}<span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Position auf dem Spielbrett (0 = Start, 72 = Ziel)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.last_dice_result.label(class="form-control-label") }}
                                    {{ form.last_dice_result(class="form-control" + (" is-invalid" if form.last_dice_result.errors else ""), placeholder="1-6", value=team.last_dice_result) }}
                                    {% if form.last_dice_result.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.last_dice_result.errors %}<span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Letztes gewürfeltes Ergebnis (1-6, leer lassen für nicht gesetzt)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teammitglieder bearbeiten -->
                
                <div class="form-group">
                    {{ form.submit(class="btn btn-primary") }}
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary ml-2">Abbrechen</a>
                </div>
            </form>
            
            <!-- Team-Spieler Management - außerhalb des Forms -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-friends"></i> Team-Spieler</h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="openAddPlayerModal()">
                        <i class="fas fa-user-plus"></i> Spieler hinzufügen
                    </button>
                </div>
                <div class="card-body">
                    {% if team.player_registrations %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Spielername</th>
                                        <th>Registriert am</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in team.player_registrations %}
                                    <tr id="player-row-{{ player.id }}">
                                        <td>
                                            <span id="player-name-{{ player.id }}">{{ player.player_name }}</span>
                                            <input type="text" class="form-control form-control-sm d-none" 
                                                   id="player-name-input-{{ player.id }}" 
                                                   value="{{ player.player_name }}" 
                                                   maxlength="100">
                                        </td>
                                        <td>{{ player.registration_time.strftime('%d.%m.%Y %H:%M') if player.registration_time else 'Unbekannt' }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        type="button"
                                                        onclick="editPlayerName({{ player.id }})" 
                                                        id="edit-btn-{{ player.id }}">
                                                    <i class="fas fa-edit"></i> Bearbeiten
                                                </button>
                                                <button class="btn btn-outline-success btn-sm d-none" 
                                                        type="button"
                                                        onclick="savePlayerName({{ player.id }})" 
                                                        id="save-btn-{{ player.id }}">
                                                    <i class="fas fa-save"></i> Speichern
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm d-none" 
                                                        type="button"
                                                        onclick="cancelPlayerEdit({{ player.id }})" 
                                                        id="cancel-btn-{{ player.id }}">
                                                    <i class="fas fa-times"></i> Abbrechen
                                                </button>
                                                <select class="form-control form-control-sm" 
                                                        style="width: auto; display: inline-block;"
                                                        onchange="handleTeamChange(this, {{ player.id }})"
                                                        id="team-select-{{ player.id }}">
                                                    <option value="">-- Team ändern --</option>
                                                    {% for other_team in all_teams %}
                                                        {% if other_team.id != team.id %}
                                                        <option value="{{ other_team.id }}">{{ other_team.name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <option value="0">Kein Team zuweisen</option>
                                                </select>
                                                <button class="btn btn-outline-danger btn-sm ml-2" 
                                                        type="button"
                                                        onclick="deletePlayer({{ player.id }})" 
                                                        title="Spieler löschen">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Diesem Team sind noch keine Spieler zugeordnet.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Erweiterte Spieler-Auslosungs-Verwaltung -->
            {% if team.player_registrations %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-dice"></i> Auslosungs-Einstellungen</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Hinweis:</strong> Hier können Sie festlegen, welche Spieler für Minispiele ausgelost werden können. 
                        Bei "Ganzes Team" spielen alle mit, unabhängig von diesen Einstellungen.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Spielername</th>
                                    <th>Kann ausgelost werden</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="player-selection-table">
                                {% set player_config = team.get_player_config() %}
                                {% for player in team.player_registrations %}
                                    {% set can_be_selected = player_config.get(player.player_name, {}).get('can_be_selected', True) %}
                                    <tr id="player-selection-row-{{ player.id }}">
                                        <td>
                                            <i class="fas fa-user text-primary"></i>
                                            <strong>{{ player.player_name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ 'success' if can_be_selected else 'secondary' }}" 
                                                  id="status-badge-{{ player.id }}">
                                                {{ 'Ja' if can_be_selected else 'Nein' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-{{ 'secondary' if can_be_selected else 'success' }}"
                                                    onclick="togglePlayerSelection('{{ player.player_name }}', {{ team.id }}, {{ player.id }}, {{ 'false' if can_be_selected else 'true' }})"
                                                    id="toggle-btn-{{ player.id }}">
                                                <i class="fas fa-{{ 'ban' if can_be_selected else 'check' }}"></i>
                                                {{ 'Deaktivieren' if can_be_selected else 'Aktivieren' }}
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Team-Info Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info"></i> Team-Informationen</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Team ID:</strong></td>
                            <td>{{ team.id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Aktuelle Position:</strong></td>
                            <td>{{ team.current_position }}</td>
                        </tr>
                        <tr>
                            <td><strong>Letzter Würfel:</strong></td>
                            <td>{{ team.last_dice_result if team.last_dice_result else 'Nicht gesetzt' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Bonus-Würfel:</strong></td>
                            <td>{{ team.bonus_dice_sides if team.bonus_dice_sides else 'Keine' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Blockiert:</strong></td>
                            <td>
                                {% if team.is_blocked %}
                                    <span class="badge badge-danger">Ja</span>
                                    {% if team.blocked_target_number %}
                                        <br><small>Benötigt: {{ team.blocked_target_number }}+</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-success">Nein</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if team.character %}
                        <tr>
                            <td><strong>Charakter:</strong></td>
                            <td>{{ team.character.name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript für Spieler-Management
function editPlayerName(playerId) {
    console.log('editPlayerName called with ID:', playerId);
    try {
        // Zeige Input-Feld und verstecke Anzeige
        document.getElementById('player-name-' + playerId).classList.add('d-none');
        document.getElementById('player-name-input-' + playerId).classList.remove('d-none');
        
        // Zeige Save/Cancel Buttons und verstecke Edit Button
        document.getElementById('edit-btn-' + playerId).classList.add('d-none');
        document.getElementById('save-btn-' + playerId).classList.remove('d-none');
        document.getElementById('cancel-btn-' + playerId).classList.remove('d-none');
        
        // Focus auf Input-Feld
        document.getElementById('player-name-input-' + playerId).focus();
    } catch (error) {
        console.error('Error in editPlayerName:', error);
        alert('Fehler beim Aktivieren des Bearbeitungsmodus.');
    }
}

function cancelPlayerEdit(playerId) {
    // Verstecke Input-Feld und zeige Anzeige
    document.getElementById('player-name-' + playerId).classList.remove('d-none');
    document.getElementById('player-name-input-' + playerId).classList.add('d-none');
    
    // Verstecke Save/Cancel Buttons und zeige Edit Button
    document.getElementById('edit-btn-' + playerId).classList.remove('d-none');
    document.getElementById('save-btn-' + playerId).classList.add('d-none');
    document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
}

function savePlayerName(playerId) {
    const newName = document.getElementById('player-name-input-' + playerId).value.trim();
    
    if (newName.length < 2) {
        alert('Spielername muss mindestens 2 Zeichen lang sein.');
        return;
    }
    
    // AJAX Request zum Speichern
    fetch('/admin/update_player_name', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_id: playerId,
            new_name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update anzeigen
            document.getElementById('player-name-' + playerId).textContent = newName;
            
            // Verstecke Input-Feld und zeige Anzeige
            document.getElementById('player-name-' + playerId).classList.remove('d-none');
            document.getElementById('player-name-input-' + playerId).classList.add('d-none');
            
            // Verstecke Save/Cancel Buttons und zeige Edit Button
            document.getElementById('edit-btn-' + playerId).classList.remove('d-none');
            document.getElementById('save-btn-' + playerId).classList.add('d-none');
            document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
            
            // Success-Meldung
            showAlert('Spielername erfolgreich aktualisiert.', 'success');
        } else {
            alert('Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern des Spielernamens.');
    });
}

function handleTeamChange(selectElement, playerId) {
    const newTeamId = parseInt(selectElement.value);
    if (!newTeamId && newTeamId !== 0) {
        return; // Keine Auswahl getroffen
    }
    
    const newTeamName = selectElement.options[selectElement.selectedIndex].text;
    
    // Reset select nach Bestätigung/Abbruch
    const resetSelect = () => {
        selectElement.selectedIndex = 0;
    };
    
    const confirmMsg = newTeamId === 0 
        ? 'Möchten Sie den Spieler wirklich keinem Team zuweisen?' 
        : `Möchten Sie den Spieler wirklich dem Team "${newTeamName}" zuweisen?`;
    
    if (!confirm(confirmMsg)) {
        resetSelect();
        return;
    }
    
    reassignPlayer(playerId, newTeamId, newTeamName, resetSelect);
}

function reassignPlayer(playerId, newTeamId, newTeamName, callback = null) {
    console.log('reassignPlayer called:', {playerId, newTeamId, newTeamName});
    
    // AJAX Request für Team-Zuordnung
    fetch('/admin/reassign_player', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_id: playerId,
            new_team_id: newTeamId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (newTeamId === 0) {
                // Spieler aus aktuellem Team entfernen
                document.getElementById('player-row-' + playerId).remove();
                showAlert('Spieler erfolgreich aus dem Team entfernt.', 'info');
            } else {
                // Spieler aus aktuellem Team entfernen
                document.getElementById('player-row-' + playerId).remove();
                showAlert(`Spieler erfolgreich dem Team "${newTeamName}" zugewiesen.`, 'success');
            }
            
            // Prüfe ob noch Spieler im Team sind
            const remainingRows = document.querySelectorAll('tbody tr[id^="player-row-"]');
            if (remainingRows.length === 0) {
                location.reload(); // Reload um "Keine Spieler" Nachricht anzuzeigen
            }
        } else {
            alert('Fehler bei der Team-Zuweisung: ' + (data.error || 'Unbekannter Fehler'));
            if (callback) callback(); // Reset select bei Fehler
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler bei der Team-Zuweisung.');
        if (callback) callback(); // Reset select bei Fehler
    });
}

function showAlert(message, type) {
    // Erstelle temporäre Alert-Box
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    // Füge Alert oben auf der Seite hinzu
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Entferne Alert nach 5 Sekunden
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Enter-Taste für Speichern
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        const target = event.target;
        if (target.id && target.id.startsWith('player-name-input-')) {
            const playerId = target.id.replace('player-name-input-', '');
            savePlayerName(playerId);
        }
    }
});

// Neue Funktion für Spieler-Auslosungs-Verwaltung
function togglePlayerSelection(playerName, teamId, rowIndex, newStatus) {
    console.log('togglePlayerSelection called:', {playerName, teamId, rowIndex, newStatus});
    
    const canBeSelected = newStatus === 'true';
    
    // AJAX Request für Auslosungs-Status
    fetch(`/admin/api/update_player_selection_status/${teamId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_name: playerName,
            can_be_selected: canBeSelected
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // UI aktualisieren
            const statusBadge = document.getElementById(`status-badge-${rowIndex}`);
            const toggleBtn = document.getElementById(`toggle-btn-${rowIndex}`);
            
            if (canBeSelected) {
                statusBadge.textContent = 'Ja';
                statusBadge.className = 'badge badge-success';
                toggleBtn.innerHTML = '<i class="fas fa-ban"></i> Deaktivieren';
                toggleBtn.className = 'btn btn-sm btn-secondary';
                toggleBtn.setAttribute('onclick', `togglePlayerSelection('${playerName}', ${teamId}, ${rowIndex}, 'false')`);
            } else {
                statusBadge.textContent = 'Nein';
                statusBadge.className = 'badge badge-secondary';
                toggleBtn.innerHTML = '<i class="fas fa-check"></i> Aktivieren';
                toggleBtn.className = 'btn btn-sm btn-success';
                toggleBtn.setAttribute('onclick', `togglePlayerSelection('${playerName}', ${teamId}, ${rowIndex}, 'true')`);
            }
            
            // Erfolgs-Toast oder Notification
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message || 'Fehler beim Aktualisieren', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ein Fehler ist aufgetreten', 'error');
    });
}

function showNotification(message, type) {
    // Einfache Benachrichtigung (kann erweitert werden)
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        <strong>${type === 'success' ? 'Erfolg!' : 'Fehler!'}</strong> ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove nach 3 Sekunden
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Neues Modal-System für Spieler hinzufügen
function openAddPlayerModal() {
    document.getElementById('add-player-modal').style.display = 'flex';
    document.getElementById('add-player-name').focus();
    
    // Reset modal state
    resetAddPlayerModal();
}

function closeAddPlayerModal() {
    document.getElementById('add-player-modal').style.display = 'none';
    resetAddPlayerModal();
}

function resetAddPlayerModal() {
    // Reset zu Step 1
    document.getElementById('add-player-step-1').style.display = 'block';
    document.getElementById('add-player-step-2').style.display = 'none';
    
    // Reset step indicators
    document.getElementById('add-player-step-dot-1').classList.add('active');
    document.getElementById('add-player-step-dot-2').classList.remove('active');
    
    // Reset form
    document.getElementById('add-player-name').value = '';
    document.getElementById('add-player-status').style.display = 'none';
    
    // Reset camera
    resetAddPlayerCamera();
}

function proceedToAddPlayerCamera() {
    const playerName = document.getElementById('add-player-name').value.trim();
    if (!playerName) {
        showAddPlayerStatus('Bitte gib einen Namen ein!', 'error');
        return;
    }
    
    if (playerName.length < 2) {
        showAddPlayerStatus('Name muss mindestens 2 Zeichen lang sein!', 'error');
        return;
    }
    
    // Switch to camera step
    document.getElementById('add-player-step-1').style.display = 'none';
    document.getElementById('add-player-step-2').style.display = 'block';
    
    // Update step indicator
    document.getElementById('add-player-step-dot-1').classList.remove('active');
    document.getElementById('add-player-step-dot-2').classList.add('active');
    
    // Clear status
    document.getElementById('add-player-status').style.display = 'none';
    
    resetAddPlayerCamera();
}

function backToAddPlayerNameStep() {
    // Stop camera if running
    stopAddPlayerCamera();
    
    // Switch back to name step
    document.getElementById('add-player-step-2').style.display = 'none';
    document.getElementById('add-player-step-1').style.display = 'block';
    
    // Update step indicator
    document.getElementById('add-player-step-dot-2').classList.remove('active');
    document.getElementById('add-player-step-dot-1').classList.add('active');
    
    // Clear status
    document.getElementById('add-player-status').style.display = 'none';
}

// Kamera-Funktionen für Spieler-Hinzufügen
let addPlayerCameraStream = null;
let addPlayerCapturedImageData = null;

function resetAddPlayerCamera() {
    stopAddPlayerCamera();
    
    document.getElementById('add-player-btn-start-camera').style.display = 'inline-block';
    document.getElementById('add-player-btn-take-photo').style.display = 'none';
    document.getElementById('add-player-btn-retake-photo').style.display = 'none';
    document.getElementById('add-player-btn-save-and-add').style.display = 'none';
    
    document.getElementById('add-player-camera-video').style.display = 'block';
    document.getElementById('add-player-camera-captured').style.display = 'none';
    
    document.getElementById('add-player-camera-status').textContent = 'Klicke auf "Kamera starten" um ein Foto aufzunehmen.';
    
    addPlayerCapturedImageData = null;
}

async function startAddPlayerCamera() {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Kamera wird gestartet...';
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Kamera-API nicht verfügbar. HTTPS oder neuerer Browser erforderlich.');
        }
        
        try {
            addPlayerCameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 640, max: 1280 }
                } 
            });
        } catch (basicError) {
            addPlayerCameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' }
            });
        }
        
        const video = document.getElementById('add-player-camera-video');
        video.srcObject = addPlayerCameraStream;
        
        video.onloadedmetadata = function() {
            video.play();
            document.getElementById('add-player-btn-start-camera').style.display = 'none';
            document.getElementById('add-player-btn-take-photo').style.display = 'inline-block';
            document.getElementById('add-player-camera-status').textContent = 'Kamera aktiv - Position dich gut und klicke auf "Foto aufnehmen".';
        };
        
    } catch (error) {
        console.error('Kamera-Fehler:', error);
        document.getElementById('add-player-camera-status').innerHTML = `
            <div style="color: #ff6b6b;">❌ Kamera konnte nicht gestartet werden: ${error.message}</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Du kannst trotzdem "Ohne Foto fortfahren" wählen.</div>
        `;
        
        const skipButton = document.getElementById('add-player-btn-skip-photo');
        if (skipButton) {
            skipButton.style.background = 'linear-gradient(45deg, #4CAF50, #45A049)';
            skipButton.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto hinzufügen (empfohlen)';
        }
    }
}

function stopAddPlayerCamera() {
    if (addPlayerCameraStream) {
        addPlayerCameraStream.getTracks().forEach(track => track.stop());
        addPlayerCameraStream = null;
    }
}

function takeAddPlayerPhoto() {
    const video = document.getElementById('add-player-camera-video');
    const canvas = document.getElementById('add-player-camera-canvas');
    const capturedImg = document.getElementById('add-player-camera-captured');
    
    canvas.width = 150;
    canvas.height = 150;
    
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(75, 75, 75, 0, 2 * Math.PI);
    ctx.clip();
    
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    
    addPlayerCapturedImageData = canvas.toDataURL('image/jpeg', 0.85);
    
    capturedImg.src = addPlayerCapturedImageData;
    capturedImg.style.display = 'block';
    video.style.display = 'none';
    
    document.getElementById('add-player-btn-take-photo').style.display = 'none';
    document.getElementById('add-player-btn-retake-photo').style.display = 'inline-block';
    document.getElementById('add-player-btn-save-and-add').style.display = 'inline-block';
    
    document.getElementById('add-player-camera-status').textContent = 'Foto aufgenommen! Gefällt es dir?';
    
    stopAddPlayerCamera();
}

function retakeAddPlayerPhoto() {
    document.getElementById('add-player-camera-video').style.display = 'block';
    document.getElementById('add-player-camera-captured').style.display = 'none';
    
    document.getElementById('add-player-btn-retake-photo').style.display = 'none';
    document.getElementById('add-player-btn-save-and-add').style.display = 'none';
    document.getElementById('add-player-btn-start-camera').style.display = 'inline-block';
    
    addPlayerCapturedImageData = null;
    document.getElementById('add-player-camera-status').textContent = 'Klicke auf "Kamera starten" um es nochmal zu versuchen.';
}

async function savePhotoAndAddPlayer() {
    const playerName = document.getElementById('add-player-name').value.trim();
    
    if (!playerName) {
        showAddPlayerStatus('Spielername fehlt!', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('add-player-btn-save-and-add');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird hinzugefügt...';
    }
    
    try {
        // Erst Spieler hinzufügen
        const playerAdded = await addPlayerToTeam(playerName);
        
        // Dann Foto hochladen falls erfolgreich und Foto vorhanden
        if (playerAdded && addPlayerCapturedImageData) {
            await uploadPlayerImage(playerName);
        }
    } finally {
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Speichern & Hinzufügen';
        }
    }
}

async function skipPhotoAndAddPlayer() {
    const playerName = document.getElementById('add-player-name').value.trim();
    
    if (!playerName) {
        showAddPlayerStatus('Spielername fehlt!', 'error');
        return;
    }
    
    const skipBtn = document.getElementById('add-player-btn-skip-photo');
    if (skipBtn) {
        skipBtn.disabled = true;
        skipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird hinzugefügt...';
    }
    
    try {
        await addPlayerToTeam(playerName);
    } finally {
        if (skipBtn) {
            skipBtn.disabled = false;
            skipBtn.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto hinzufügen';
        }
    }
}

async function addPlayerToTeam(playerName) {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Spieler wird hinzugefügt...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        const response = await fetch('/admin/add_player_to_team', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                team_id: {{ team.id }},
                player_name: playerName 
            })
        });
        
        // Response als Text holen und dann als JSON parsen
        const responseText = await response.text();
        console.log('Response text:', responseText);
        
        if (!response.ok) {
            let errorMessage;
            try {
                const errorData = JSON.parse(responseText);
                errorMessage = errorData.error || `HTTP error! status: ${response.status}`;
            } catch (parseError) {
                console.error('Response text:', responseText);
                errorMessage = `HTTP error! status: ${response.status} - ${responseText.substring(0, 100)}`;
            }
            throw new Error(errorMessage);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Expected JSON, got:', responseText);
            throw new Error('Server returned non-JSON response: ' + responseText.substring(0, 100));
        }
        
        const data = JSON.parse(responseText);
        
        if (data.success) {
            document.getElementById('add-player-camera-status').textContent = '✅ Spieler erfolgreich hinzugefügt!';
            showAddPlayerStatus('Erfolgreich hinzugefügt! 🎉', 'success');
            
            // Aktualisiere das Team-Members Textfeld
            updateTeamMembersField();
            
            setTimeout(() => {
                closeAddPlayerModal();
                // Reload page to show new player in the list
                window.location.reload();
            }, 2000);
            return true;
        } else {
            showAddPlayerStatus(data.error || 'Fehler beim Hinzufügen', 'error');
            document.getElementById('add-player-camera-status').innerHTML = `<div style="color: #ff6b6b;">❌ ${data.error || 'Fehler beim Hinzufügen'}</div>`;
            return false;
        }
        
    } catch (error) {
        console.error('Add player error:', error);
        const errorMessage = error.message || 'Ein Fehler ist aufgetreten. Versuche es nochmal!';
        showAddPlayerStatus(errorMessage, 'error');
        document.getElementById('add-player-camera-status').innerHTML = `<div style="color: #ff6b6b;">❌ ${errorMessage}</div>`;
        return false;
    }
}

async function uploadPlayerImage(playerName) {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Profilbild wird gespeichert...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        const response = await fetch('/admin/upload_team_player_image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                team_id: {{ team.id }},
                player_name: playerName,
                image_data: addPlayerCapturedImageData
            })
        });
        
        if (!response.ok) {
            let errorMessage;
            try {
                // Erst response text holen, dann versuchen als JSON zu parsen
                const responseText = await response.text();
                console.error('Upload response text:', responseText);
                
                try {
                    const errorData = JSON.parse(responseText);
                    errorMessage = errorData.error || `HTTP error! status: ${response.status}`;
                } catch (jsonError) {
                    errorMessage = `HTTP error! status: ${response.status} - ${responseText.substring(0, 100)}`;
                }
            } catch (textError) {
                errorMessage = `HTTP error! status: ${response.status}`;
            }
            throw new Error(errorMessage);
        }
        
        // Response als Text holen und dann als JSON parsen
        const responseText = await response.text();
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Expected JSON, got:', responseText);
            throw new Error('Server returned non-JSON response: ' + responseText.substring(0, 100));
        }
        
        const result = JSON.parse(responseText);
        
        if (result.success) {
            document.getElementById('add-player-camera-status').textContent = '✅ Profilbild gespeichert!';
            showAddPlayerStatus('Erfolgreich hinzugefügt mit Profilbild! 🎉📸', 'success');
        } else {
            showAddPlayerStatus('Hinzugefügt, aber Profilbild-Fehler: ' + result.error, 'error');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        showAddPlayerStatus('Hinzugefügt, aber Profilbild konnte nicht gespeichert werden.', 'error');
    }
}

function updateTeamMembersField() {
    // Diese Funktion aktualisiert das Members-Textfeld
    // Da wir die Seite neu laden, ist das hier nicht nötig
    // Aber für den Fall, dass wir es später brauchen
}

function showAddPlayerStatus(message, type) {
    const statusDiv = document.getElementById('add-player-status');
    const messageSpan = document.getElementById('add-player-status-message');
    
    statusDiv.className = `add-player-status status-${type}`;
    messageSpan.textContent = message;
    statusDiv.style.display = 'block';
}

// ESC-Taste zum Schließen des Modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('add-player-modal').style.display === 'flex') {
        closeAddPlayerModal();
    }
});

// Cleanup bei Seitenverlassen
window.addEventListener('beforeunload', function() {
    stopAddPlayerCamera();
});

// Spieler löschen Funktion
function deletePlayer(playerId) {
    if (!confirm('Möchten Sie diesen Spieler wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/admin/delete_player', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            player_id: playerId
        })
    })
    .then(response => {
        return response.text().then(text => ({
            ok: response.ok,
            status: response.status,
            text: text
        }));
    })
    .then(({ok, status, text}) => {
        console.log('Delete response:', text);
        
        if (!ok) {
            try {
                const errorData = JSON.parse(text);
                throw new Error(errorData.error || `HTTP error! status: ${status}`);
            } catch (parseError) {
                throw new Error(`HTTP error! status: ${status} - ${text.substring(0, 100)}`);
            }
        }
        
        const data = JSON.parse(text);
        
        if (data.success) {
            // Entferne Spieler-Zeile aus der Tabelle
            document.getElementById('player-row-' + playerId).remove();
            alert('Spieler erfolgreich gelöscht!');
        } else {
            alert('Fehler beim Löschen: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Fehler beim Löschen des Spielers: ' + error.message);
    });
}
</script>

<!-- Modal für Spieler hinzufügen -->
<div id="add-player-modal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <button class="modal-close" onclick="closeAddPlayerModal()">&times;</button>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-dot active" id="add-player-step-dot-1"></div>
            <div class="step-dot" id="add-player-step-dot-2"></div>
        </div>
        
        <!-- Step 1: Name eingeben -->
        <div id="add-player-step-1" class="modal-step">
            <div class="modal-header">
                <h3 class="modal-title">👥 Spieler zu {{ team.name }} hinzufügen</h3>
                <p class="modal-subtitle">Trage den Namen des neuen Spielers ein!</p>
            </div>

            <div class="modal-form">
                <div class="form-group">
                    <label for="add-player-name" class="form-label">Spielername:</label>
                    <input type="text" id="add-player-name" class="form-input" placeholder="Gib den Namen ein..." maxlength="50" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-modal btn-modal-primary" onclick="proceedToAddPlayerCamera()">
                        <i class="fas fa-camera"></i> Weiter zum Foto
                    </button>
                    <button type="button" class="btn-modal btn-modal-secondary" onclick="closeAddPlayerModal()">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Camera -->
        <div id="add-player-step-2" class="modal-step camera-step" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">📸 Profilbild aufnehmen</h3>
                <p class="modal-subtitle">Nimm ein Foto für den Spieler auf!</p>
            </div>

            <div class="camera-preview">
                <video id="add-player-camera-video" class="camera-video" autoplay muted></video>
                <canvas id="add-player-camera-canvas" class="camera-canvas"></canvas>
                <img id="add-player-camera-captured" class="camera-captured" style="display: none;">
            </div>
            
            <div class="camera-controls">
                <button id="add-player-btn-start-camera" class="btn-camera btn-camera-capture" onclick="startAddPlayerCamera()">
                    <i class="fas fa-video"></i> Kamera starten
                </button>
                <button id="add-player-btn-take-photo" class="btn-camera btn-camera-capture" style="display: none;" onclick="takeAddPlayerPhoto()">
                    <i class="fas fa-camera"></i> Foto aufnehmen
                </button>
                <button id="add-player-btn-retake-photo" class="btn-camera btn-camera-retake" style="display: none;" onclick="retakeAddPlayerPhoto()">
                    <i class="fas fa-redo"></i> Nochmal
                </button>
                <button id="add-player-btn-save-and-add" class="btn-camera btn-camera-save" style="display: none;" onclick="savePhotoAndAddPlayer()">
                    <i class="fas fa-save"></i> Speichern & Hinzufügen
                </button>
                <button id="add-player-btn-skip-photo" class="btn-camera btn-camera-skip" onclick="skipPhotoAndAddPlayer()">
                    <i class="fas fa-forward"></i> Ohne Foto hinzufügen
                </button>
            </div>
            
            <div class="camera-status" id="add-player-camera-status">
                Klicke auf "Kamera starten" um ein Foto aufzunehmen.
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="backToAddPlayerNameStep()">
                    <i class="fas fa-arrow-left"></i> Zurück
                </button>
            </div>
        </div>

        <div id="add-player-status" class="add-player-status" style="display: none;">
            <span id="add-player-status-message"></span>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    position: relative;
    color: white;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.modal-close:hover {
    opacity: 1;
}

.modal-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.modal-subtitle {
    opacity: 0.9;
    font-size: 1rem;
}

.modal-form {
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-input {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1rem;
    backdrop-filter: blur(10px);
}

.form-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.form-input:focus {
    outline: none;
    border-color: #FFD700;
    background: rgba(255, 255, 255, 0.2);
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-modal {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.btn-modal-primary {
    background: #FFD700;
    color: #333;
}

.btn-modal-primary:hover {
    background: #FFC107;
    transform: translateY(-2px);
}

.btn-modal-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-modal-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

/* Übernehme die Kamera-Styles aus index.html */
.camera-preview {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 1rem auto;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.2);
}

.camera-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-canvas {
    display: none;
}

.camera-captured {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin: 1rem 0;
}

.btn-camera {
    padding: 0.6rem 1rem;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.btn-camera-capture {
    background: linear-gradient(45deg, #FF6B6B, #EE5A52);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
}

.btn-camera-capture:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 107, 0.5);
}

.btn-camera-retake {
    background: linear-gradient(45deg, #FFA726, #FF9800);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
}

.btn-camera-retake:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 167, 38, 0.5);
}

.btn-camera-save {
    background: linear-gradient(45deg, #4CAF50, #45A049);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.btn-camera-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
}

.btn-camera-skip {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-camera-skip:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.camera-status {
    margin: 0.5rem 0;
    font-size: 0.9rem;
    opacity: 0.9;
    min-height: 20px;
    text-align: center;
}

.step-indicator {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
}

.step-dot.active {
    background: #FFD700;
    transform: scale(1.2);
}

.add-player-status {
    text-align: center;
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 10px;
    display: none;
}

.status-success {
    background: rgba(76, 175, 80, 0.3);
    border: 1px solid rgba(76, 175, 80, 0.5);
}

.status-error {
    background: rgba(244, 67, 54, 0.3);
    border: 1px solid rgba(244, 67, 54, 0.5);
}

@media (max-width: 480px) {
    .modal-container {
        padding: 1.5rem;
        margin: 1rem;
    }
    
    .modal-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}