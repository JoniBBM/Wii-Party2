{% extends "base.html" %}

{% block title %}Quiz erstellen in {{ folder.name }} - Admin Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Neues Quiz erstellen
                    </h3>
                    <p class="mb-0 mt-2">
                        <i class="fas fa-folder"></i> Ordner: <strong>{{ folder.name }}</strong>
                    </p>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.create_quiz', folder_id=folder.id) }}" novalidate id="quiz-form">
                        {{ form.hidden_tag() }}
                        
                        <!-- Quiz-Grunddaten -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    {{ form.name.label(class="form-control-label") }}
                                    {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), 
                                                 placeholder="z.B. Wissenstest Geografie, Schnellraten, Film & TV") }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.name.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.time_limit.label(class="form-control-label") }}
                                    {{ form.time_limit(class="form-control" + (" is-invalid" if form.time_limit.errors else "")) }}
                                    {% if form.time_limit.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.time_limit.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">0 = unbegrenzt</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.description.label(class="form-control-label") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), 
                                               rows="3", placeholder="Beschreibe das Quiz und gib den Teams Hinweise...") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <hr>
                        
                        <!-- Fragen-Bereich -->
                        <div class="questions-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-question-circle"></i> Quiz-Fragen</h4>
                                <button type="button" class="btn btn-success" id="add-question-btn">
                                    <i class="fas fa-plus"></i> Frage hinzufügen
                                </button>
                            </div>
                            
                            <div id="questions-container">
                                <!-- Fragen werden hier dynamisch hinzugefügt -->
                            </div>
                            
                            <div id="no-questions-message" class="alert alert-warning text-center">
                                <i class="fas fa-info-circle"></i> 
                                Noch keine Fragen hinzugefügt. Klicke auf "Frage hinzufügen" um zu beginnen.
                            </div>
                        </div>
                        
                        <!-- Hidden field für Questions JSON -->
                        {{ form.questions_json(id="questions-json-field") }}
                        
                        <div class="form-group mt-4">
                            {{ form.submit(class="btn btn-primary btn-lg", id="submit-btn") }}
                            <a href="{{ url_for('admin.edit_folder', folder_id=folder.id) }}" class="btn btn-secondary btn-lg ml-2">
                                Abbrechen
                            </a>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Tipps:</h6>
                            <small class="text-muted">
                                • Multiple Choice: 2-4 Antwortoptionen<br>
                                • Freitext: Teams tippen die Antwort ein<br>
                                • Punkte können pro Frage individuell vergeben werden
                            </small>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-play text-success"></i> Verwendung:</h6>
                            <small class="text-muted">
                                Das Quiz wird automatisch für Spielrunden verfügbar, die diesen Ordner nutzen.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question Template (hidden) -->
<div id="question-template" style="display: none;">
    <div class="question-card card mb-3">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <span class="question-number">Frage 1</span>
                    <span class="question-type-badge badge badge-secondary ml-2">Multiple Choice</span>
                </h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary move-question-up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary move-question-down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger remove-question">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="form-control-label">Frage:</label>
                        <textarea class="form-control question-text" rows="2" placeholder="Wie lautet die Frage?" required></textarea>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="form-control-label">Typ:</label>
                        <select class="form-control question-type" required>
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="text_input">Freitext</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="form-control-label">Punkte:</label>
                        <input type="number" class="form-control question-points" min="1" max="100" value="10" required>
                    </div>
                </div>
            </div>
            
            <!-- Multiple Choice Options -->
            <div class="multiple-choice-section">
                <label class="form-control-label">Antwortoptionen:</label>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="radio" class="correct-option" name="correct_option_temp" value="1">
                                    </div>
                                </div>
                                <input type="text" class="form-control option-1" placeholder="Option 1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="radio" class="correct-option" name="correct_option_temp" value="2">
                                    </div>
                                </div>
                                <input type="text" class="form-control option-2" placeholder="Option 2" required>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="radio" class="correct-option" name="correct_option_temp" value="3">
                                    </div>
                                </div>
                                <input type="text" class="form-control option-3" placeholder="Option 3 (optional)">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="radio" class="correct-option" name="correct_option_temp" value="4">
                                    </div>
                                </div>
                                <input type="text" class="form-control option-4" placeholder="Option 4 (optional)">
                            </div>
                        </div>
                    </div>
                </div>
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Wähle die korrekte Antwort durch Anklicken des Radio-Buttons aus.
                </small>
            </div>
            
            <!-- Text Input Section -->
            <div class="text-input-section" style="display: none;">
                <div class="form-group">
                    <label class="form-control-label">Korrekte Antwort:</label>
                    <input type="text" class="form-control correct-text" placeholder="Die korrekte Antwort (Groß-/Kleinschreibung wird ignoriert)">
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Teams müssen diese Antwort exakt eingeben (Groß-/Kleinschreibung wird ignoriert).
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.question-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.question-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.question-type-badge {
    font-size: 0.7rem;
}

.input-group-text {
    background-color: #f8f9fa;
}

.correct-option:checked + .form-control {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.questions-section {
    min-height: 200px;
}

#no-questions-message {
    border: 2px dashed #ffc107;
    background-color: #fff3cd;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.card {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let questionCounter = 0;
    const questionsContainer = document.getElementById('questions-container');
    const noQuestionsMessage = document.getElementById('no-questions-message');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const questionsJsonField = document.getElementById('questions-json-field');
    const submitBtn = document.getElementById('submit-btn');
    
    function updateNoQuestionsMessage() {
        const questionCards = questionsContainer.querySelectorAll('.question-card');
        noQuestionsMessage.style.display = questionCards.length === 0 ? 'block' : 'none';
        
        // Update submit button state
        submitBtn.disabled = questionCards.length === 0;
        if (questionCards.length === 0) {
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Mindestens eine Frage erforderlich';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        } else {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Quiz erstellen';
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        }
    }
    
    function updateQuestionNumbers() {
        const questionCards = questionsContainer.querySelectorAll('.question-card');
        questionCards.forEach((card, index) => {
            const questionNumber = card.querySelector('.question-number');
            questionNumber.textContent = `Frage ${index + 1}`;
            
            // Update radio button names to be unique per question
            const radioButtons = card.querySelectorAll('.correct-option');
            const radioName = `correct_option_${index}`;
            radioButtons.forEach(radio => {
                radio.name = radioName;
            });
        });
    }
    
    function toggleQuestionType(questionCard) {
        const typeSelect = questionCard.querySelector('.question-type');
        const multipleChoiceSection = questionCard.querySelector('.multiple-choice-section');
        const textInputSection = questionCard.querySelector('.text-input-section');
        const typeBadge = questionCard.querySelector('.question-type-badge');
        
        if (typeSelect.value === 'multiple_choice') {
            multipleChoiceSection.style.display = 'block';
            textInputSection.style.display = 'none';
            typeBadge.textContent = 'Multiple Choice';
            typeBadge.className = 'question-type-badge badge badge-primary ml-2';
        } else {
            multipleChoiceSection.style.display = 'none';
            textInputSection.style.display = 'block';
            typeBadge.textContent = 'Freitext';
            typeBadge.className = 'question-type-badge badge badge-info ml-2';
        }
    }
    
    function addQuestion() {
        questionCounter++;
        
        const template = document.getElementById('question-template');
        const newQuestion = template.cloneNode(true);
        newQuestion.id = '';
        newQuestion.style.display = 'block';
        
        // Add event listeners
        const typeSelect = newQuestion.querySelector('.question-type');
        typeSelect.addEventListener('change', () => toggleQuestionType(newQuestion));
        
        const removeBtn = newQuestion.querySelector('.remove-question');
        removeBtn.addEventListener('click', () => {
            newQuestion.remove();
            updateQuestionNumbers();
            updateNoQuestionsMessage();
        });
        
        const moveUpBtn = newQuestion.querySelector('.move-question-up');
        moveUpBtn.addEventListener('click', () => {
            const prev = newQuestion.previousElementSibling;
            if (prev && prev.classList.contains('question-card')) {
                questionsContainer.insertBefore(newQuestion, prev);
                updateQuestionNumbers();
            }
        });
        
        const moveDownBtn = newQuestion.querySelector('.move-question-down');
        moveDownBtn.addEventListener('click', () => {
            const next = newQuestion.nextElementSibling;
            if (next && next.classList.contains('question-card')) {
                questionsContainer.insertBefore(next, newQuestion);
                updateQuestionNumbers();
            }
        });
        
        questionsContainer.appendChild(newQuestion);
        updateQuestionNumbers();
        updateNoQuestionsMessage();
        
        // Scroll to new question
        newQuestion.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function collectQuestionsData() {
        const questions = [];
        const questionCards = questionsContainer.querySelectorAll('.question-card');
        
        questionCards.forEach((card, index) => {
            const questionText = card.querySelector('.question-text').value.trim();
            const questionType = card.querySelector('.question-type').value;
            const questionPoints = parseInt(card.querySelector('.question-points').value) || 10;
            
            if (!questionText) return; // Skip empty questions
            
            const questionData = {
                id: `q_${Date.now()}_${index}`,
                text: questionText,
                type: questionType,
                points: questionPoints
            };
            
            if (questionType === 'multiple_choice') {
                const options = [];
                for (let i = 1; i <= 4; i++) {
                    const optionInput = card.querySelector(`.option-${i}`);
                    if (optionInput && optionInput.value.trim()) {
                        options.push(optionInput.value.trim());
                    }
                }
                
                const correctOption = card.querySelector('.correct-option:checked');
                const correctIndex = correctOption ? parseInt(correctOption.value) - 1 : 0;
                
                if (options.length >= 2) { // Minimum 2 options required
                    questionData.options = options;
                    questionData.correct_option = correctIndex;
                }
            } else if (questionType === 'text_input') {
                const correctText = card.querySelector('.correct-text').value.trim();
                if (correctText) {
                    questionData.correct_text = correctText;
                }
            }
            
            questions.push(questionData);
        });
        
        return questions;
    }
    
    // Event listeners
    addQuestionBtn.addEventListener('click', addQuestion);
    
    // Form submission
    document.getElementById('quiz-form').addEventListener('submit', function(e) {
        const questions = collectQuestionsData();
        
        if (questions.length === 0) {
            e.preventDefault();
            alert('Bitte füge mindestens eine gültige Frage hinzu.');
            return;
        }
        
        // Validate questions
        let valid = true;
        questions.forEach((q, index) => {
            if (q.type === 'multiple_choice') {
                if (!q.options || q.options.length < 2) {
                    valid = false;
                    alert(`Frage ${index + 1}: Mindestens 2 Antwortoptionen erforderlich.`);
                }
            } else if (q.type === 'text_input') {
                if (!q.correct_text) {
                    valid = false;
                    alert(`Frage ${index + 1}: Korrekte Antwort ist erforderlich.`);
                }
            }
        });
        
        if (!valid) {
            e.preventDefault();
            return;
        }
        
        questionsJsonField.value = JSON.stringify(questions);
    });
    
    // Initialize
    updateNoQuestionsMessage();
    
    // Add first question automatically
    addQuestion();
});
</script>
{% endblock %}