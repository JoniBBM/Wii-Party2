{% extends "base.html" %}

{% block title %}Moderationsmodus - Wii Party U Deluxe{% endblock %}

{% block extra_css %}
<style>
.dice-display {
    text-align: center;
    padding: 10px;
}

.dice-display .h1, .dice-display .h2, .dice-display .h4 {
    margin-bottom: 5px;
    font-weight: bold;
}

#dice-result-display {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

#dice-result-display.fade-out {
    animation: fadeOut 0.5s ease-out;
}

@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
}

/* Mobile Fix: Stelle sicher, dass Würfelergebnis-Display korrekt positioniert ist */
#dice-result-display {
    position: relative !important;
    z-index: auto !important;
}

@media (max-width: 768px) {
    #dice-result-display {
        position: static !important;
        z-index: auto !important;
        transform: none !important;
    }
    
    .dice-display {
        text-align: center;
        padding: 8px;
    }
    
    .dice-display .h1, .dice-display .h2, .dice-display .h4 {
        font-size: 1.2rem;
        margin-bottom: 3px;
    }
    
    /* Ablaufplan mobile Optimierung */
    #sequence-info-display .card {
        margin: 0 10px !important;
    }
    
    #sequence-info-display .row.mb-3 {
        margin-bottom: 1rem !important;
    }
    
    #sequence-info-display .col-md-4 {
        margin-top: 10px;
    }
    
    #sequence-info-display .card-body .row .col-md-4 {
        text-align: center;
        margin-top: 15px;
    }
    
    #sequence-info-display .card-body .row .col-md-8 {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="mb-4">
        <!-- Desktop: Titel und Button nebeneinander -->
        <div class="d-none d-md-flex justify-content-between align-items-center">
            <h1>Moderationsmodus</h1>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Zurück zum Admin Dashboard
            </a>
        </div>
        
        <!-- Mobile: Nur Titel -->
        <div class="d-md-none">
            <h1>Moderationsmodus</h1>
        </div>
    </div>
    
    <!-- Aktueller Spielstatus -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-eye"></i> Aktueller Spielstatus</h5>
                </div>
                <div class="card-body">
                    {% if game_status %}
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Status:</strong>
                                <span class="badge badge-{{ game_status.status_color }} badge-lg">
                                    {{ game_status.current_status }}
                                </span>
                            </div>
                            
                            {% if game_status.current_team %}
                            <div class="col-md-3">
                                <strong>Aktuelles Team:</strong>
                                <span class="badge badge-primary">{{ game_status.current_team }}</span>
                            </div>
                            {% endif %}
                            
                            
                        </div>
                        
                        {% if game_status.additional_info %}
                        <div class="mt-3">
                            <strong>Details:</strong>
                            <p class="mb-0">{{ game_status.additional_info }}</p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-pause-circle fa-3x mb-3"></i>
                            <p>Spiel ist momentan nicht aktiv</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailansicht für Fragen/Minigames oder Ergebnisse -->
    <!-- IMMER RENDERN aber anfangs versteckt -->
    <div class="row mb-5" id="initial-content-card" style="{% if not (game_status and (game_status.content_details or (game_status.results and game_status.results.has_results))) %}display: none;{% endif %}">
        <div class="col-12">
            <div id="content-card-inner">
                {% if game_status and game_status.content_details %}
                <div class="card border-{{ game_status.content_details.type_color }}">
                    <div class="card-header bg-{{ game_status.content_details.type_color }} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-{{ game_status.content_details.icon }}"></i> 
                            {{ game_status.content_details.type_name }}: {{ game_status.content_details.name }}
                        </h5>
                    </div>
                {% elif game_status and game_status.results and game_status.results.has_results %}
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> 
                            Letzte Ergebnisse
                        </h5>
                    </div>
                {% else %}
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> 
                            Inhalt
                        </h5>
                    </div>
                {% endif %}
                <div class="card-body">
                    {% if game_status.content_details %}
                        {% if game_status.content_details.description %}
                            <p><strong>Beschreibung:</strong> {{ game_status.content_details.description }}</p>
                        {% endif %}
                        
                        {% if game_status.content_details.question_text %}
                            <div class="mb-3">
                                <strong>Frage:</strong>
                                <p class="h5 text-primary">{{ game_status.content_details.question_text }}</p>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.options %}
                            <div class="mb-3">
                                <strong>Antwortmöglichkeiten:</strong>
                                <div class="row">
                                    {% for option in game_status.content_details.options %}
                                    <div class="col-md-6 mb-2">
                                        <span class="badge badge-light badge-lg">{{ loop.index }}. {{ option }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.correct_answer %}
                            <div class="alert alert-success">
                                <strong>Korrekte Antwort:</strong> {{ game_status.content_details.correct_answer }}
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.duration %}
                            <p><strong>Dauer:</strong> {{ game_status.content_details.duration }}</p>
                        {% endif %}
                        
                        {% if game_status.content_details.instructions %}
                            <div class="alert alert-info">
                                <strong>Anweisungen:</strong> {{ game_status.content_details.instructions }}
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.selected_players %}
                            <div class="mb-3">
                                <strong>Ausgeloste Spieler:</strong>
                                <div class="row">
                                    {% for team_name, player_name in game_status.content_details.selected_players.items() %}
                                    <div class="col-md-4 mb-2">
                                        <div class="card border-primary">
                                            <div class="card-body p-2">
                                                <strong>{{ team_name }}:</strong><br>
                                                <span class="text-primary">{{ player_name }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.team_responses %}
                            <div class="mb-3">
                                <strong>Team-Antworten:</strong>
                                <div id="team-responses-section">
                                    {% if game_status.content_details.team_responses.detailed_responses %}
                                        <div class="mt-2">
                                            <small class="text-muted">{{ game_status.content_details.team_responses.total_responses }}/{{ game_status.content_details.team_responses.total_teams }} Teams haben geantwortet</small>
                                        </div>
                                        <div class="row mt-2">
                                            {% for response in game_status.content_details.team_responses.detailed_responses %}
                                            <div class="col-md-6 mb-2">
                                                <div class="card border-{% if response.is_correct %}success{% else %}danger{% endif %}">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>{{ response.team_name }}</strong>
                                                                <small class="d-block text-muted">{{ response.answer_preview }}</small>
                                                                {% if response.answered_at %}
                                                                    <small class="text-muted">{{ response.answered_at }}</small>
                                                                {% endif %}
                                                            </div>
                                                            <span>
                                                                {% if response.is_correct %}
                                                                    <i class="fas fa-check text-success"></i>
                                                                {% else %}
                                                                    <i class="fas fa-times text-danger"></i>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% if game_status.content_details.team_responses.total_responses == game_status.content_details.team_responses.total_teams and game_status.content_details.team_responses.total_teams > 0 %}
                                            <div class="alert alert-success mt-2 mb-0">
                                                <i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="row mt-2">
                                            <div class="col-md-6">
                                                <h6 class="text-success">✓ Geantwortet:</h6>
                                                {% if game_status.content_details.team_responses.answered %}
                                                    {% for team in game_status.content_details.team_responses.answered %}
                                                    <span class="badge badge-success mr-1 mb-1">{{ team }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">Noch keine Antworten</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-warning">⏳ Ausstehend:</h6>
                                                {% if game_status.content_details.team_responses.pending %}
                                                    {% for team in game_status.content_details.team_responses.pending %}
                                                    <span class="badge badge-warning mr-1 mb-1">{{ team }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">Alle haben geantwortet</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if game_status.results and game_status.results.has_results %}
                        <div class="mb-3">
                            <strong>🏆 Platzierungen:</strong>
                            <div class="row">
                                {% for result in game_status.results.placements %}
                                <div class="col-md-4 mb-2">
                                    <div class="card border-{% if result.placement == 1 %}warning{% elif result.placement == 2 %}secondary{% elif result.placement == 3 %}info{% else %}light{% endif %}">
                                        <div class="card-body p-2 text-center">
                                            <div class="h4 mb-1">
                                                {% if result.placement == 1 %}🥇
                                                {% elif result.placement == 2 %}🥈
                                                {% elif result.placement == 3 %}🥉
                                                {% else %}{{ result.placement }}.{% endif %}
                                            </div>
                                            <strong>{{ result.team_name }}</strong>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- AKTIVER ABLAUFPLAN - IMMER SICHTBAR -->
    <div class="row mb-5" id="sequence-info-display">
        <div class="col-12">
            <div class="card border-info shadow-sm" style="margin: 0 15px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol"></i> 
                        Aktiver Ablaufplan: {% if sequence_info %}{{ sequence_info.name }}{% else %}Wird geladen...{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>Fortschritt</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-info" id="sequence-progress-bar"
                                     style="width: {% if sequence_info %}{{ sequence_info.progress_percentage }}{% else %}0{% endif %}%">
                                    {% if sequence_info %}{{ sequence_info.progress_percentage }}{% else %}0{% endif %}%
                                </div>
                            </div>
                            <small class="text-muted" id="sequence-position-text">
                                {% if sequence_info %}{{ sequence_info.current_position + 1 }} von {{ sequence_info.total_items }} abgeschlossen{% else %}Lade Informationen...{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <div class="text-right">
                                {% if sequence_info and sequence_info.current_item %}
                                    <h6 class="text-warning">
                                        <i class="fas fa-play"></i> Aktuell:
                                    </h6>
                                    <div class="card border-warning">
                                        <div class="card-body p-2">
                                            {% if sequence_info.current_item.type == 'minigame' %}
                                                <i class="fas fa-gamepad text-primary"></i>
                                            {% else %}
                                                <i class="fas fa-question-circle text-info"></i>
                                            {% endif %}
                                            <strong>{{ sequence_info.current_item.name }}</strong>
                                        </div>
                                    </div>
                                {% else %}
                                    <h6 class="text-muted">
                                        <i class="fas fa-clock"></i> Wird geladen...
                                    </h6>
                                {% endif %}
                                
                                {% if sequence_info and sequence_info.next_item %}
                                    <h6 class="text-muted mt-3">
                                        <i class="fas fa-step-forward"></i> Als nächstes:
                                    </h6>
                                    <div class="card border-light">
                                        <div class="card-body p-2">
                                            {% if sequence_info.next_item.type == 'minigame' %}
                                                <i class="fas fa-gamepad text-primary"></i>
                                            {% else %}
                                                <i class="fas fa-question-circle text-info"></i>
                                            {% endif %}
                                            <strong>{{ sequence_info.next_item.name }}</strong>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vollständige Sequenz-Liste -->
                    <div class="collapse" id="full-sequence-list">
                        <hr>
                        <h6><i class="fas fa-list"></i> Vollständiger Ablaufplan:</h6>
                        <div class="row">
                            {% if sequence_info and sequence_info.sequence_list %}
                                {% for item in sequence_info.sequence_list %}
                                <div class="col-md-4 mb-2">
                                    <div class="card border-{% if loop.index0 < sequence_info.current_position %}success{% elif loop.index0 == sequence_info.current_position %}warning{% else %}light{% endif %}">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <span class="badge badge-primary mr-2">{{ loop.index }}</span>
                                                {% if item.type == 'minigame' %}
                                                    <i class="fas fa-gamepad text-primary mr-1"></i>
                                                {% else %}
                                                    <i class="fas fa-question-circle text-info mr-1"></i>
                                                {% endif %}
                                                <small class="flex-grow-1">{{ item.name }}</small>
                                                {% if loop.index0 < sequence_info.current_position %}
                                                    <i class="fas fa-check text-success"></i>
                                                {% elif loop.index0 == sequence_info.current_position %}
                                                    <i class="fas fa-play text-warning"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12 text-center text-muted">
                                    <i class="fas fa-clock"></i> Lade Ablaufplan...
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-info btn-sm" type="button" data-toggle="collapse" data-target="#full-sequence-list">
                            <i class="fas fa-list"></i> Vollständigen Plan anzeigen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WÜRFELERGEBNIS-ANZEIGE - LIVE UPDATES -->
    <div class="row mb-4" id="dice-result-display" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dice"></i> 
                        Würfelergebnis
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Team</small>
                                <div class="h4" id="dice-team-name">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Standard</small>
                                <div class="h2 text-primary" id="dice-standard">-</div>
                            </div>
                        </div>
                        <div class="col-md-3" id="dice-bonus-section" style="display: none;">
                            <div class="dice-display">
                                <small class="text-muted">Bonus</small>
                                <div class="h2 text-warning" id="dice-bonus">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Gesamt</small>
                                <div class="h1 text-success font-weight-bold" id="dice-total">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="dice-timestamp">Zeit: --:--:--</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Mobile: Zurück-Button am Ende der Seite -->
    <div class="row mt-5 d-block d-md-none">
        <div class="col-12 text-center">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Zurück zum Admin Dashboard
            </a>
        </div>
    </div>
    
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastPhase = null;
    let diceResultTimeout = null;
    let lastDiceResult = null;
    
    // AJAX Auto-Update alle 3 Sekunden - VEREINFACHT UND ROBUSTER
    function updateStatus() {
        fetch('{{ url_for("admin.moderation_mode_api") }}')
            .then(response => response.json())
            .then(data => {
                console.log('Update data received:', data);
                
                if (data.game_status) {
                    // Erkenne Phasenwechsel
                    const currentPhase = data.game_status.current_status;
                    if (lastPhase && lastPhase !== currentPhase) {
                        console.log(`Phase changed from ${lastPhase} to ${currentPhase}`);
                        handlePhaseChange(lastPhase, currentPhase);
                    }
                    lastPhase = currentPhase;
                    
                    updateStatusSection(data.game_status);
                    updateContentSection(data.game_status);
                    
                    // Debug dice result data
                    console.log('Dice result in game_status:', data.game_status.dice_result);
                    updateDiceResultSection(data.game_status);
                } else {
                    showInactiveGame();
                }
                
                // Update Sequenz-Informationen
                updateSequenceSection(data.sequence_info);
            })
            .catch(error => {
                console.error('Update failed:', error);
            });
    }
    
    function handlePhaseChange(oldPhase, newPhase) {
        const contentPhases = ['Frage läuft', 'Frage', 'Minispiel', 'Ergebnisse', 'Runde beendet'];
        const wasContentPhase = contentPhases.includes(oldPhase);
        const isContentPhase = contentPhases.includes(newPhase);
        
        // Wenn von Content-Phase zu Würfelrunde gewechselt wird, blende Content aus
        if (wasContentPhase && newPhase === 'Würfelrunde') {
            console.log('Hiding content due to phase change to dice rolling');
            hideContentCard();
        }
        
        // Wenn von Ergebnissen zu neuer Frage/Minispiel gewechselt wird, räume auf
        if ((oldPhase === 'Ergebnisse' || oldPhase === 'Runde beendet') && isContentPhase && newPhase !== 'Ergebnisse' && newPhase !== 'Runde beendet') {
            console.log('Clearing old results due to new content');
            clearContentCard();
        }
        
        // Wenn zu Content-Phase gewechselt wird, stelle sicher dass Content angezeigt wird
        if (!wasContentPhase && isContentPhase) {
            console.log('Switching to content phase, ensuring content is visible');
            // Lass updateContentSection das handhaben
        }
        
        // Würfelergebnis bei Phasenwechsel von Würfelrunde weg - VERLÄNGERTE ANZEIGE
        if (oldPhase === 'Würfelrunde' && newPhase !== 'Würfelrunde') {
            console.log('Phase changed away from dice rolling - extending dice result display for 10 seconds');
            
            // Lösche vorherigen Timeout
            if (diceResultTimeout) {
                clearTimeout(diceResultTimeout);
            }
            
            // Verlängerte Anzeige für 10 Sekunden nach Ende der Würfelrunde
            diceResultTimeout = setTimeout(() => {
                console.log('Hiding dice result after extended display (10 seconds)');
                hideDiceResult();
            }, 10000);
        }
    }
    
    function hideContentCard() {
        const contentCard = document.querySelector('#initial-content-card');
        if (contentCard) {
            contentCard.style.display = 'none';
        }
    }
    
    function clearContentCard() {
        const contentCard = document.querySelector('#initial-content-card');
        if (contentCard) {
            // Entferne alte Ergebnisse
            const resultsSection = contentCard.querySelector('.results-section');
            if (resultsSection) {
                resultsSection.remove();
            }
            
            // Setze Team-Antworten zurück
            const responsesSection = contentCard.querySelector('#team-responses-section');
            if (responsesSection) {
                responsesSection.innerHTML = '<div class="text-center text-muted"><i class="fas fa-clock"></i> Warte auf Antworten...</div>';
            }
        }
    }
    
    function updateStatusSection(gameStatus) {
        // Update Status Badge
        const statusBadge = document.querySelector('.badge-lg');
        if (statusBadge) {
            statusBadge.className = `badge badge-${gameStatus.status_color} badge-lg`;
            statusBadge.textContent = gameStatus.current_status;
        }
        
        // Update Team Info
        const teamCol = document.querySelector('.col-md-3:nth-child(2)');
        if (teamCol) {
            if (gameStatus.current_team) {
                teamCol.innerHTML = `<strong>Aktuelles Team:</strong>
                    <span class="badge badge-primary">${gameStatus.current_team}</span>`;
            } else {
                teamCol.innerHTML = '';
            }
        }
        
        // Update Details
        const detailsDiv = document.querySelector('.mt-3 p');
        if (detailsDiv && gameStatus.additional_info) {
            detailsDiv.textContent = gameStatus.additional_info;
        }
    }
    
    function updateContentSection(gameStatus) {
        const contentCard = document.querySelector('#initial-content-card');
        const currentPhase = gameStatus.current_status;
        
        // Zeige Content bei allen relevanten Phasen - ERWEITERT UM "RUNDE BEENDET"
        const showContentPhases = ['Frage läuft', 'Frage', 'Minispiel', 'Ergebnisse', 'Runde beendet'];
        const shouldShowContent = showContentPhases.includes(currentPhase) && 
                                 (gameStatus.content_details || (gameStatus.results && gameStatus.results.has_results));
        
        console.log(`Phase: ${currentPhase}, Should show content: ${shouldShowContent}, Has content_details: ${!!gameStatus.content_details}, Has results: ${!!(gameStatus.results && gameStatus.results.has_results)}`);
        
        if (shouldShowContent) {
            if (contentCard) {
                contentCard.style.display = 'block';
                console.log('Showing content card - display set to block');
                
                // Update the entire content card
                updateContentCardContent(gameStatus);
            } else {
                console.error('Content card element not found! Creating or showing content...');
                ensureContentCardExists(gameStatus);
            }
        } else {
            // Verstecke Content nur bei Würfelrunde oder wirklich unbekannten Phasen
            if (contentCard && currentPhase === 'Würfelrunde') {
                console.log(`Hiding content card for phase: ${currentPhase}`);
                contentCard.style.display = 'none';
            }
        }
    }
    
    function ensureContentCardExists(gameStatus) {
        // Prüfe ob das initial content card existiert aber versteckt ist
        let contentCard = document.querySelector('#initial-content-card');
        
        if (!contentCard) {
            console.log('Initial content card not found, checking template...');
            return;
        }
        
        // Force show the content card
        contentCard.style.display = 'block';
        contentCard.style.visibility = 'visible';
        
        console.log('Content card forced to show');
        
        // Rebuild the content card inner HTML dynamically
        updateContentCardContent(gameStatus);
    }
    
    function updateContentCardContent(gameStatus) {
        const contentInner = document.querySelector('#content-card-inner');
        if (!contentInner) return;
        
        let html = '';
        
        if (gameStatus.content_details) {
            html = `
                <div class="card border-${gameStatus.content_details.type_color}">
                    <div class="card-header bg-${gameStatus.content_details.type_color} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-${gameStatus.content_details.icon}"></i> 
                            ${gameStatus.content_details.type_name}: ${gameStatus.content_details.name}
                        </h5>
                    </div>
                    <div class="card-body">
                        ${gameStatus.content_details.description ? `<p><strong>Beschreibung:</strong> ${gameStatus.content_details.description}</p>` : ''}
                        ${gameStatus.content_details.question_text ? `<div class="mb-3"><strong>Frage:</strong><p class="h5 text-primary">${gameStatus.content_details.question_text}</p></div>` : ''}
                        ${gameStatus.content_details.options ? generateOptionsHTML(gameStatus.content_details.options) : ''}
                        ${gameStatus.content_details.correct_answer ? `<div class="alert alert-success"><strong>Korrekte Antwort:</strong> ${gameStatus.content_details.correct_answer}</div>` : ''}
                        ${gameStatus.content_details.duration ? `<p><strong>Dauer:</strong> ${gameStatus.content_details.duration}</p>` : ''}
                        ${gameStatus.content_details.instructions ? `<div class="alert alert-info"><strong>Anweisungen:</strong> ${gameStatus.content_details.instructions}</div>` : ''}
                        ${gameStatus.content_details.selected_players ? generatePlayersHTML(gameStatus.content_details.selected_players) : ''}
                        ${gameStatus.content_details.team_responses ? generateResponsesHTML(gameStatus.content_details.team_responses) : ''}
                    </div>
                </div>
            `;
        } else if (gameStatus.results && gameStatus.results.has_results) {
            html = `
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> 
                            Ergebnisse
                        </h5>
                    </div>
                    <div class="card-body">
                        ${generateResultsHTML(gameStatus.results)}
                    </div>
                </div>
            `;
        }
        
        contentInner.innerHTML = html;
        console.log('Content card inner HTML updated');
    }
    
    function generateOptionsHTML(options) {
        if (!options || options.length === 0) return '';
        let html = '<div class="mb-3"><strong>Antwortmöglichkeiten:</strong><div class="row">';
        options.forEach((option, index) => {
            html += `<div class="col-md-6 mb-2"><span class="badge badge-light badge-lg">${index + 1}. ${option}</span></div>`;
        });
        html += '</div></div>';
        return html;
    }
    
    function generatePlayersHTML(players) {
        if (!players || Object.keys(players).length === 0) return '';
        let html = '<div class="mb-3"><strong>Ausgeloste Spieler:</strong><div class="row">';
        Object.entries(players).forEach(([teamName, playerName]) => {
            html += `<div class="col-md-4 mb-2"><div class="card border-primary"><div class="card-body p-2"><strong>${teamName}:</strong><br><span class="text-primary">${playerName}</span></div></div></div>`;
        });
        html += '</div></div>';
        return html;
    }
    
    function generateResponsesHTML(responses) {
        if (!responses) return '';
        
        if (responses.detailed_responses && responses.detailed_responses.length > 0) {
            let html = `<div class="mb-3" id="team-responses-section">
                <strong>Team-Antworten:</strong>
                <div class="mt-2">
                    <small class="text-muted">${responses.total_responses}/${responses.total_teams} Teams haben geantwortet</small>
                </div>
                <div class="row mt-2">`;
            
            responses.detailed_responses.forEach(response => {
                const borderClass = response.is_correct ? 'success' : 'danger';
                const icon = response.is_correct ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-${borderClass}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${response.team_name}</strong>
                                        <small class="d-block text-muted">${response.answer_preview}</small>
                                        ${response.answered_at ? `<small class="text-muted">${response.answered_at}</small>` : ''}
                                    </div>
                                    <span><i class="${icon}"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (responses.total_responses === responses.total_teams && responses.total_teams > 0) {
                html += '<div class="alert alert-success mt-2 mb-0"><i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Fallback zu einfacher Anzeige
        let html = '<div class="mb-3"><strong>Team-Antworten:</strong><div class="row">';
        html += '<div class="col-md-6"><h6 class="text-success">✓ Geantwortet:</h6>';
        if (responses.answered && responses.answered.length > 0) {
            responses.answered.forEach(team => {
                html += `<span class="badge badge-success mr-1 mb-1">${team}</span>`;
            });
        } else {
            html += '<span class="text-muted">Noch keine Antworten</span>';
        }
        html += '</div><div class="col-md-6"><h6 class="text-warning">⏳ Ausstehend:</h6>';
        if (responses.pending && responses.pending.length > 0) {
            responses.pending.forEach(team => {
                html += `<span class="badge badge-warning mr-1 mb-1">${team}</span>`;
            });
        } else {
            html += '<span class="text-muted">Alle haben geantwortet</span>';
        }
        html += '</div></div></div>';
        return html;
    }
    
    function updateTeamResponses(teamResponses) {
        const responsesSection = document.querySelector('#team-responses-section');
        if (!responsesSection) return;
        
        if (teamResponses.detailed_responses && teamResponses.detailed_responses.length > 0) {
            let html = `<div class="mt-2">
                <small class="text-muted">${teamResponses.total_responses}/${teamResponses.total_teams} Teams haben geantwortet</small>
            </div>
            <div class="row mt-2">`;
            
            teamResponses.detailed_responses.forEach(response => {
                const borderClass = response.is_correct ? 'success' : 'danger';
                const icon = response.is_correct ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-${borderClass}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${response.team_name}</strong>
                                        <small class="d-block text-muted">${response.answer_preview}</small>
                                        ${response.answered_at ? `<small class="text-muted">${response.answered_at}</small>` : ''}
                                    </div>
                                    <span><i class="${icon}"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (teamResponses.total_responses === teamResponses.total_teams && teamResponses.total_teams > 0) {
                html += '<div class="alert alert-success mt-2 mb-0"><i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!</div>';
            }
            
            responsesSection.innerHTML = html;
        }
    }
    
    function updateResults(results) {
        // Prüfe ob bereits statische Ergebnisse da sind
        const cardBody = document.querySelector('#initial-content-card .card-body');
        if (!cardBody) return;
        
        const staticResults = cardBody.innerHTML.includes('🏆 Platzierungen');
        if (!staticResults && results.placements && results.placements.length > 0) {
            // Entferne alte dynamische Ergebnisse
            const oldResults = cardBody.querySelector('.results-section');
            if (oldResults) {
                oldResults.remove();
            }
            
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'mb-3 results-section';
            resultsDiv.innerHTML = generateResultsHTML(results);
            cardBody.appendChild(resultsDiv);
        }
    }
    
    function showInactiveGame() {
        const statusCard = document.querySelector('.card-body');
        if (statusCard) {
            statusCard.innerHTML = `<div class="text-center text-muted py-4">
                <i class="fas fa-pause-circle fa-3x mb-3"></i>
                <p>Spiel ist momentan nicht aktiv</p>
            </div>`;
        }
        hideDiceResult();
    }
    
    function isRecentDiceResult(diceResult) {
        // Prüfe ob das Würfelergebnis wirklich recent ist (maximal 10 Sekunden alt)
        try {
            const now = new Date();
            const timestamp = diceResult.timestamp; // Format: "HH:MM:SS"
            
            // Parse timestamp (heute + timestamp)
            const [hours, minutes, seconds] = timestamp.split(':').map(Number);
            const diceTime = new Date();
            diceTime.setHours(hours, minutes, seconds, 0);
            
            // Wenn das Würfelergebnis von gestern ist (aber gleiche Uhrzeit heute)
            // dann ist es definitiv alt
            const timeDiff = Math.abs(now - diceTime);
            const isRecent = timeDiff <= 10000; // Maximal 10 Sekunden alt
            
            console.log(`Dice result time check: ${timestamp}, diff: ${timeDiff}ms, isRecent: ${isRecent}`);
            return isRecent;
            
        } catch (error) {
            console.error('Error checking dice result time:', error);
            return false; // Bei Fehlern als alt behandeln
        }
    }
    
    function updateDiceResultSection(gameStatus) {
        console.log(`updateDiceResultSection called - Phase: ${gameStatus.current_status}, Has dice_result: ${!!gameStatus.dice_result}`);
        
        // Nur bei Würfelrunde und wenn Würfelergebnis vorhanden UND wirklich aktuell ist
        if (gameStatus.current_status === 'Würfelrunde' && gameStatus.dice_result && gameStatus.dice_result.is_recent && isRecentDiceResult(gameStatus.dice_result)) {
            const diceResult = gameStatus.dice_result;
            console.log('Dice result data:', diceResult);
            
            // Prüfe ob es ein neues Würfelergebnis ist
            const diceKey = `${diceResult.team_name}-${diceResult.timestamp}-${diceResult.total_roll}`;
            console.log(`Dice key: ${diceKey}, Last dice result: ${lastDiceResult}`);
            
            if (lastDiceResult !== diceKey) {
                lastDiceResult = diceKey;
                showDiceResult(diceResult, gameStatus);
            } else {
                console.log('Same dice result as before, not showing again');
            }
        } else {
            console.log('No dice result to show or not in dice rolling phase');
            // Kein Würfelergebnis oder nicht in Würfelrunde
            if (gameStatus.current_status !== 'Würfelrunde') {
                hideDiceResult();
            }
        }
    }
    
    function showDiceResult(diceResult, gameStatus) {
        console.log('Showing dice result:', diceResult);
        
        // Prüfe ob alle Elemente existieren
        const diceDisplay = document.getElementById('dice-result-display');
        const teamNameEl = document.getElementById('dice-team-name');
        const standardEl = document.getElementById('dice-standard');
        const totalEl = document.getElementById('dice-total');
        const timestampEl = document.getElementById('dice-timestamp');
        const bonusSection = document.getElementById('dice-bonus-section');
        const bonusEl = document.getElementById('dice-bonus');
        
        console.log('Element check:', {
            diceDisplay: !!diceDisplay,
            teamNameEl: !!teamNameEl,
            standardEl: !!standardEl,
            totalEl: !!totalEl,
            timestampEl: !!timestampEl,
            bonusSection: !!bonusSection,
            bonusEl: !!bonusEl
        });
        
        if (!diceDisplay) {
            console.error('dice-result-display element not found!');
            return;
        }
        
        // Aktualisiere Werte
        if (teamNameEl) teamNameEl.textContent = diceResult.team_name;
        if (standardEl) standardEl.textContent = diceResult.standard_roll;
        if (totalEl) totalEl.textContent = diceResult.total_roll;
        if (timestampEl) timestampEl.textContent = `Zeit: ${diceResult.timestamp}`;
        
        // Bonus-Sektion nur anzeigen wenn Bonus-Würfel vorhanden
        if (bonusSection && bonusEl) {
            if (diceResult.has_bonus && diceResult.bonus_roll > 0) {
                bonusEl.textContent = diceResult.bonus_roll;
                bonusSection.style.display = 'block';
            } else {
                bonusSection.style.display = 'none';
            }
        }
        
        // Zeige das Würfelergebnis-Feld - SOFORT UND VOLLSTÄNDIG SICHTBAR
        diceDisplay.style.display = 'block';
        diceDisplay.style.visibility = 'visible';
        diceDisplay.style.opacity = '1';
        // Entferne problematische Position- und z-index-Styles für mobile Geräte
        diceDisplay.style.position = '';
        diceDisplay.style.zIndex = '';
        diceDisplay.style.width = 'auto';
        diceDisplay.style.height = 'auto';
        
        // Entferne alle Klassen, die das Element verstecken könnten
        diceDisplay.classList.remove('fade-out');
        
        console.log('Dice display element shown, style.display:', diceDisplay.style.display);
        
        // Warte kurz und prüfe dann nochmal die Größe
        setTimeout(() => {
            console.log('Element position and size after timeout:', {
                offsetTop: diceDisplay.offsetTop,
                offsetLeft: diceDisplay.offsetLeft,
                offsetWidth: diceDisplay.offsetWidth,
                offsetHeight: diceDisplay.offsetHeight,
                computed: window.getComputedStyle(diceDisplay).display,
                visibility: window.getComputedStyle(diceDisplay).visibility,
                opacity: window.getComputedStyle(diceDisplay).opacity
            });
        }, 100);
        
        // Lösche vorherigen Timeout
        if (diceResultTimeout) {
            clearTimeout(diceResultTimeout);
        }
        
        // Auto-Ausblenden nach 5 Sekunden (normale Würfelrunde)
        // Verlängerte Anzeige wird durch Phasenwechsel-Handler übernommen
        diceResultTimeout = setTimeout(() => {
            console.log('Auto-hiding dice result after 5 seconds (normal dice roll)');
            hideDiceResult();
        }, 5000);
    }
    
    function hideDiceResult() {
        const diceDisplay = document.getElementById('dice-result-display');
        if (diceDisplay && diceDisplay.style.display !== 'none') {
            // Smooth fade-out animation
            diceDisplay.classList.add('fade-out');
            
            setTimeout(() => {
                diceDisplay.style.display = 'none';
                diceDisplay.classList.remove('fade-out');
            }, 500);
        }
        
        if (diceResultTimeout) {
            clearTimeout(diceResultTimeout);
            diceResultTimeout = null;
        }
        
        lastDiceResult = null;
    }
    function generateResultsHTML(results) {
        if (!results || !results.placements || results.placements.length === 0) return '';
        let html = '<strong>🏆 Platzierungen:</strong><div class="row mt-2">';
        results.placements.forEach(result => {
            let medal = result.placement === 1 ? '🥇' : result.placement === 2 ? '🥈' : result.placement === 3 ? '🥉' : `${result.placement}.`;
            let borderClass = result.placement === 1 ? 'warning' : result.placement === 2 ? 'secondary' : result.placement === 3 ? 'info' : 'light';
            html += `<div class="col-md-4 mb-2">
                <div class="card border-${borderClass}">
                    <div class="card-body p-2 text-center">
                        <div class="h4 mb-1">${medal}</div>
                        <strong>${result.team_name}</strong>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        return html;
    }
    
    function updateSequenceSection(sequenceInfo) {
        const sequenceDisplay = document.getElementById('sequence-info-display');
        
        // FIXE: Sequenz-Anzeige IMMER sichtbar machen - egal ob sequenceInfo vorhanden ist
        if (sequenceDisplay) {
            sequenceDisplay.style.display = 'block';
            sequenceDisplay.style.visibility = 'visible';
            console.log('Sequence display forced to be visible');
        }
        
        if (sequenceInfo) {
            console.log('Updating sequence info:', sequenceInfo);
            
            // Update Fortschrittsbalken
            const progressBar = document.getElementById('sequence-progress-bar');
            if (progressBar) {
                progressBar.style.width = sequenceInfo.progress_percentage + '%';
                progressBar.textContent = sequenceInfo.progress_percentage + '%';
            }
            
            // Update Position Text
            const positionText = document.getElementById('sequence-position-text');
            if (positionText) {
                positionText.textContent = `${sequenceInfo.current_position + 1} von ${sequenceInfo.total_items} abgeschlossen`;
            }
            
            // Dynamisch Sequenz-Karte erstellen falls nicht vorhanden
            const sequenceCard = document.getElementById('sequence-info-card');
            if (sequenceCard && sequenceCard.innerHTML.trim() === '') {
                updateSequenceCard(sequenceCard, sequenceInfo);
            }
        } else {
            console.log('No sequence info received, but keeping display visible');
        }
        // Sequenz-Anzeige wird NIEMALS versteckt - bleibt permanent sichtbar
    }
    
    function updateSequenceCard(cardElement, sequenceInfo) {
        let html = `
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list-ol"></i> 
                    Aktiver Ablaufplan: ${sequenceInfo.name}
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h6>Fortschritt</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-info" id="sequence-progress-bar"
                                 style="width: ${sequenceInfo.progress_percentage}%">
                                ${sequenceInfo.progress_percentage}%
                            </div>
                        </div>
                        <small class="text-muted" id="sequence-position-text">
                            ${sequenceInfo.current_position + 1} von ${sequenceInfo.total_items} abgeschlossen
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="text-right">`;
        
        if (sequenceInfo.current_item) {
            const currentIcon = sequenceInfo.current_item.type === 'minigame' ? 'fas fa-gamepad text-primary' : 'fas fa-question-circle text-info';
            html += `
                            <h6 class="text-warning">
                                <i class="fas fa-play"></i> Aktuell:
                            </h6>
                            <div class="card border-warning">
                                <div class="card-body p-2">
                                    <i class="${currentIcon}"></i>
                                    <strong>${sequenceInfo.current_item.name}</strong>
                                </div>
                            </div>`;
        }
        
        if (sequenceInfo.next_item) {
            const nextIcon = sequenceInfo.next_item.type === 'minigame' ? 'fas fa-gamepad text-primary' : 'fas fa-question-circle text-info';
            html += `
                            <h6 class="text-muted mt-3">
                                <i class="fas fa-step-forward"></i> Als nächstes:
                            </h6>
                            <div class="card border-light">
                                <div class="card-body p-2">
                                    <i class="${nextIcon}"></i>
                                    <strong>${sequenceInfo.next_item.name}</strong>
                                </div>
                            </div>`;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>`;
        
        cardElement.innerHTML = html;
    }
    
    // Stelle sicher, dass Sequenz-Anzeige beim Laden sichtbar ist
    const sequenceDisplay = document.getElementById('sequence-info-display');
    if (sequenceDisplay) {
        sequenceDisplay.style.display = 'block';
        sequenceDisplay.style.visibility = 'visible';
        console.log('Initial sequence display made visible');
    }
    
    // Starte Updates alle 3 Sekunden
    setInterval(updateStatus, 3000);
    
    // Initialer Update nach 1 Sekunde
    setTimeout(updateStatus, 1000);
});
</script>
{% endblock %}