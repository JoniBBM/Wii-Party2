{% extends "base.html" %}

{% block title %}Quiz-Ergebnisse: {{ quiz_data.name if quiz_data else 'Unbekanntes Quiz' }} - Admin Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-chart-bar mr-2 text-primary"></i>
                Quiz-Ergebnisse
            </h2>
            {% if quiz_data %}
                <h4 class="text-muted">{{ quiz_data.name }}</h4>
                {% if quiz_data.description %}
                    <p class="text-muted">{{ quiz_data.description }}</p>
                {% endif %}
            {% endif %}
        </div>
        <div>
            <button onclick="window.location.reload()" class="btn btn-success">
                <i class="fas fa-sync-alt mr-2"></i>Aktualisieren
            </button>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary ml-2">
                <i class="fas fa-arrow-left mr-2"></i>Zurück zum Dashboard
            </a>
        </div>
    </div>

    {% if quiz_data %}
        <!-- Quiz Information -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            Quiz-Informationen
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Fragen:</strong><br>
                                <span class="h5 text-primary">{{ quiz_data.questions|length if quiz_data.questions else 0 }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Zeitlimit:</strong><br>
                                <span class="h5 text-warning">
                                    {% if quiz_data.time_limit and quiz_data.time_limit > 0 %}
                                        {{ quiz_data.time_limit }}s
                                    {% else %}
                                        Unbegrenzt
                                    {% endif %}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <strong>Teams geantwortet:</strong><br>
                                <span class="h5 text-success">{{ team_responses|length }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Session:</strong><br>
                                <span class="h5 text-secondary">{{ active_session.id if active_session else 'N/A' }}</span>
                            </div>
                        </div>
                        
                        {% if active_session and active_session.quiz_started_at %}
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Gestartet um:</strong> 
                                    {{ active_session.quiz_started_at.strftime('%H:%M:%S') }}
                                </div>
                                <div class="col-md-6">
                                    {% if quiz_data.time_limit and quiz_data.time_limit > 0 %}
                                        <strong>Status:</strong>
                                        <span id="quiz-status" class="badge badge-info">Läuft</span>
                                        <div class="progress mt-2" style="height: 8px;">
                                            <div class="progress-bar bg-warning" id="time-progress" style="width: 100%"></div>
                                        </div>
                                        <small id="time-remaining" class="text-muted">Berechne...</small>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Results Overview -->
        {% if team_responses %}
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-trophy mr-2"></i>
                                Team-Ergebnisse Übersicht
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Rang</th>
                                            <th>Team</th>
                                            <th>Punkte</th>
                                            <th>Richtige Antworten</th>
                                            <th>Fortschritt</th>
                                            <th>Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set sorted_teams = team_responses.values() | sort(attribute='total_points', reverse=true) %}
                                        {% for team_data in sorted_teams %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge rank-{{ loop.index }}">
                                                    {% if loop.index == 1 %}
                                                        <i class="fas fa-crown text-warning"></i>
                                                    {% elif loop.index == 2 %}
                                                        <i class="fas fa-medal text-secondary"></i>
                                                    {% elif loop.index == 3 %}
                                                        <i class="fas fa-medal text-warning"></i>
                                                    {% else %}
                                                        {{ loop.index }}
                                                    {% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>{{ team_data.team.name }}</strong>
                                                {% if team_data.team.character %}
                                                    <br><small class="text-muted">{{ team_data.team.character.name }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="h5 text-primary">{{ team_data.total_points }}</span>
                                                {% if quiz_data.questions %}
                                                    <br><small class="text-muted">von {{ quiz_data.questions|sum(attribute='points') }} max.</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="text-success">{{ team_data.correct_answers }}</span>
                                                {% if quiz_data.questions %}
                                                    / {{ quiz_data.questions|length }}
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-success" 
                                                             style="width: {{ (team_data.correct_answers / quiz_data.questions|length * 100)|round(1) }}%">
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="text-info">{{ team_data.responses|length }}</span>
                                                {% if quiz_data.questions %}
                                                    / {{ quiz_data.questions|length }} Fragen
                                                    {% if team_data.responses|length == quiz_data.questions|length %}
                                                        <br><small class="text-success"><i class="fas fa-check"></i> Vollständig</small>
                                                    {% else %}
                                                        <br><small class="text-warning"><i class="fas fa-clock"></i> Läuft</small>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="showTeamDetails({{ team_data.team.id }})">
                                                    <i class="fas fa-eye"></i> Details
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results per Question -->
            {% if quiz_data.questions %}
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-question-circle mr-2"></i>
                                    Detailierte Ergebnisse pro Frage
                                </h5>
                            </div>
                            <div class="card-body">
                                {% for question in quiz_data.questions %}
                                <div class="question-result-section mb-4 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="text-primary">
                                                <i class="fas fa-question mr-1"></i>
                                                Frage {{ loop.index }}
                                                <span class="badge badge-info ml-2">{{ question.points }} Punkte</span>
                                            </h6>
                                            <p class="mb-2">{{ question.text }}</p>
                                            
                                            {% if question.type == 'multiple_choice' %}
                                                <div class="correct-answer mb-2">
                                                    <strong class="text-success">Richtige Antwort:</strong>
                                                    {% if question.options and question.correct_option is defined %}
                                                        {{ question.options[question.correct_option] }}
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="answer-distribution">
                                                    <strong>Antwortverteilung:</strong>
                                                    {% set question_responses = [] %}
                                                    {% for team_id, team_data in team_responses.items() %}
                                                        {% for response in team_data.responses %}
                                                            {% if response.question_id == question.id %}
                                                                {% set _ = question_responses.append(response) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                    
                                                    {% if question_responses %}
                                                        <div class="row mt-2">
                                                            {% for option_idx in range(question.options|length) %}
                                                                {% set option_count = question_responses | selectattr('selected_option', 'equalto', option_idx) | list | length %}
                                                                {% set option_percentage = (option_count / question_responses|length * 100) if question_responses else 0 %}
                                                                <div class="col-md-6 col-lg-3 mb-2">
                                                                    <div class="option-stat">
                                                                        <div class="d-flex justify-content-between">
                                                                            <span class="{% if option_idx == question.correct_option %}text-success font-weight-bold{% endif %}">
                                                                                {{ question.options[option_idx] }}
                                                                                {% if option_idx == question.correct_option %}
                                                                                    <i class="fas fa-check text-success"></i>
                                                                                {% endif %}
                                                                            </span>
                                                                            <span class="badge badge-secondary">{{ option_count }}</span>
                                                                        </div>
                                                                        <div class="progress mt-1" style="height: 6px;">
                                                                            <div class="progress-bar {% if option_idx == question.correct_option %}bg-success{% else %}bg-secondary{% endif %}" 
                                                                                 style="width: {{ option_percentage }}%">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted mt-2">Noch keine Antworten eingegangen.</p>
                                                    {% endif %}
                                                </div>
                                                
                                            {% elif question.type == 'text_input' %}
                                                <div class="correct-answer mb-2">
                                                    <strong class="text-success">Erwartete Antwort:</strong>
                                                    {{ question.correct_text }}
                                                </div>
                                                
                                                <div class="text-answers">
                                                    <strong>Eingegangene Antworten:</strong>
                                                    {% set text_responses = [] %}
                                                    {% for team_id, team_data in team_responses.items() %}
                                                        {% for response in team_data.responses %}
                                                            {% if response.question_id == question.id %}
                                                                {% set _ = text_responses.append(response) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                    
                                                    {% if text_responses %}
                                                        <div class="mt-2">
                                                            {% for response in text_responses %}
                                                                <div class="answer-item p-2 mb-1 border rounded {% if response.is_correct %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                                                    <strong>{{ response.team.name }}:</strong>
                                                                    "{{ response.answer_text }}"
                                                                    {% if response.is_correct %}
                                                                        <i class="fas fa-check text-success ml-2"></i>
                                                                        <span class="badge badge-success">{{ response.points_earned }} Punkte</span>
                                                                    {% else %}
                                                                        <i class="fas fa-times text-danger ml-2"></i>
                                                                        <span class="badge badge-danger">0 Punkte</span>
                                                                    {% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted mt-2">Noch keine Antworten eingegangen.</p>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="question-stats text-right">
                                            {% set correct_responses = [] %}
                                            {% for team_id, team_data in team_responses.items() %}
                                                {% for response in team_data.responses %}
                                                    {% if response.question_id == question.id and response.is_correct %}
                                                        {% set _ = correct_responses.append(response) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            
                                            {% set total_responses = [] %}
                                            {% for team_id, team_data in team_responses.items() %}
                                                {% for response in team_data.responses %}
                                                    {% if response.question_id == question.id %}
                                                        {% set _ = total_responses.append(response) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            
                                            <div class="stat-item">
                                                <div class="h4 text-success mb-0">{{ correct_responses|length }}</div>
                                                <small class="text-muted">richtig beantwortet</small>
                                            </div>
                                            <div class="stat-item mt-2">
                                                <div class="h5 text-info mb-0">{{ total_responses|length }}</div>
                                                <small class="text-muted">gesamt beantwortet</small>
                                            </div>
                                            {% if total_responses %}
                                                <div class="mt-2">
                                                    <div class="h6 text-primary">{{ (correct_responses|length / total_responses|length * 100)|round(1) }}%</div>
                                                    <small class="text-muted">Erfolgsrate</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info text-center">
                <h4><i class="fas fa-info-circle"></i> Noch keine Antworten</h4>
                <p>Es sind noch keine Team-Antworten für dieses Quiz eingegangen.</p>
                <p class="mb-0">Die Ergebnisse werden automatisch aktualisiert, sobald Teams antworten.</p>
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-warning text-center">
            <h4><i class="fas fa-exclamation-triangle"></i> Quiz nicht gefunden</h4>
            <p>Das angeforderte Quiz konnte nicht geladen werden.</p>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>Zurück zum Dashboard
            </a>
        </div>
    {% endif %}
</div>

<!-- Team Details Modal -->
<div class="modal fade" id="teamDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Team-Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="teamDetailsContent">
                <!-- Wird via JavaScript befüllt -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<style>
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.9rem;
}

.rank-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: #333; }
.rank-2 { background: linear-gradient(45deg, #C0C0C0, #A9A9A9); color: #333; }
.rank-3 { background: linear-gradient(45deg, #CD7F32, #B8860B); color: white; }

.rank-badge:not(.rank-1):not(.rank-2):not(.rank-3) {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.question-result-section {
    background: #f8f9fa;
}

.option-stat {
    font-size: 0.9rem;
}

.answer-item {
    font-size: 0.9rem;
}

.bg-light-success {
    background-color: rgba(40, 167, 69, 0.1);
    border-color: rgba(40, 167, 69, 0.2);
}

.bg-light-danger {
    background-color: rgba(220, 53, 69, 0.1);
    border-color: rgba(220, 53, 69, 0.2);
}

.stat-item {
    text-align: center;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.progress {
    transition: all 0.3s ease;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>

<script>
// Quiz Timer Funktionalität
document.addEventListener('DOMContentLoaded', function() {
    {% if active_session and active_session.quiz_started_at and quiz_data and quiz_data.time_limit and quiz_data.time_limit > 0 %}
        const startTime = new Date("{{ active_session.quiz_started_at.isoformat() }}Z").getTime();
        const timeLimit = {{ quiz_data.time_limit }} * 1000; // Convert to milliseconds
        const progressBar = document.getElementById('time-progress');
        const timeRemaining = document.getElementById('time-remaining');
        const quizStatus = document.getElementById('quiz-status');
        
        function updateTimer() {
            const now = new Date().getTime();
            const elapsed = now - startTime;
            const remaining = Math.max(0, timeLimit - elapsed);
            const percentage = (remaining / timeLimit) * 100;
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                
                if (percentage > 50) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (percentage > 20) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-danger';
                }
            }
            
            if (timeRemaining) {
                const seconds = Math.floor(remaining / 1000);
                const minutes = Math.floor(seconds / 60);
                const displaySeconds = seconds % 60;
                
                if (remaining > 0) {
                    timeRemaining.textContent = `${minutes}:${displaySeconds.toString().padStart(2, '0')} verbleibend`;
                } else {
                    timeRemaining.textContent = 'Zeit abgelaufen!';
                }
            }
            
            if (quizStatus) {
                if (remaining > 0) {
                    quizStatus.textContent = 'Läuft';
                    quizStatus.className = 'badge badge-success';
                } else {
                    quizStatus.textContent = 'Beendet';
                    quizStatus.className = 'badge badge-secondary';
                }
            }
        }
        
        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);
        
        // Stop timer after quiz ends
        setTimeout(() => {
            clearInterval(timerInterval);
        }, timeLimit - (new Date().getTime() - startTime) + 5000); // +5s buffer
    {% endif %}
    
    // Auto-refresh every 10 seconds
    setInterval(() => {
        window.location.reload();
    }, 10000);
});

// Team Details Modal
function showTeamDetails(teamId) {
    const teamData = {{ team_responses | tojson }};
    const quizData = {{ quiz_data | tojson }};
    
    if (!teamData[teamId]) {
        alert('Team-Daten nicht gefunden.');
        return;
    }
    
    const team = teamData[teamId];
    let content = `
        <h6><i class="fas fa-users mr-2"></i>${team.team.name}</h6>
        <p><strong>Gesamtpunkte:</strong> ${team.total_points}</p>
        <p><strong>Richtige Antworten:</strong> ${team.correct_answers} / ${quizData.questions.length}</p>
        <hr>
        <h6>Antworten im Detail:</h6>
    `;
    
    team.responses.forEach((response, index) => {
        const question = quizData.questions.find(q => q.id === response.question_id);
        if (question) {
            content += `
                <div class="mb-3 p-2 border rounded ${response.is_correct ? 'bg-light-success' : 'bg-light-danger'}">
                    <strong>Frage ${index + 1}:</strong> ${question.text}<br>
                    <strong>Antwort:</strong> `;
            
            if (question.type === 'multiple_choice') {
                const selectedOption = question.options[response.selected_option];
                content += selectedOption;
            } else {
                content += `"${response.answer_text}"`;
            }
            
            content += `<br>
                    <strong>Punkte:</strong> ${response.points_earned}
                    ${response.is_correct ? '<i class="fas fa-check text-success ml-2"></i>' : '<i class="fas fa-times text-danger ml-2"></i>'}
                </div>
            `;
        }
    });
    
    document.getElementById('teamDetailsContent').innerHTML = content;
    $('#teamDetailsModal').modal('show');
}
</script>
{% endblock %}